<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dryness Analyzer - ULTRA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .input-section { 
            margin-bottom: 20px; 
            padding: 20px; 
            border: 2px dashed #ddd; 
            border-radius: 10px; 
            background: #fafafa;
        }
        textarea { 
            width: 100%; 
            height: 200px; 
            margin-bottom: 15px; 
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
        button { 
            padding: 12px 25px; 
            background: #dc3545; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background: #c82333;
        }
        .result { 
            margin-top: 20px; 
            padding: 20px; 
            border-radius: 10px; 
            border-left: 5px solid;
        }
        .potensi { 
            background: #d4edda; 
            color: #155724; 
            border-left-color: #28a745;
        }
        .menuju-kering { 
            background: #fff3cd; 
            color: #856404; 
            border-left-color: #ffc107;
        }
        .normal { 
            background: #d1ecf1; 
            color: #0c5460; 
            border-left-color: #17a2b8;
        }
        .chart-container { 
            margin-top: 30px; 
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .reasons-list {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }
        .reasons-list li {
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #6c757d;
        }
        .buy-recommendation {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
            text-align: center;
            font-size: 24px;
            border: 3px solid;
        }
        .buy-yes {
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
            animation: pulse 2s infinite;
        }
        .buy-wait {
            background: #fff3cd;
            color: #856404;
            border-color: #ffc107;
        }
        .buy-no {
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .signal-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        .signal-strong { background: #28a745; color: white; }
        .signal-medium { background: #ffc107; color: black; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Stock Dryness Analyzer - ULTRA AGGRESSIVE</h1>
        <p>Deteksi SUPER EARLY kondisi saham kering - Optimized untuk data Anda</p>
        
        <div class="input-section">
            <h3>üìä Paste Data Saham (Format Original):</h3>
            <p><small>Copy-paste data 5-10 hari TERAKHIR sebelum hari yang ingin diprediksi</small></p>
            <textarea id="stockData" placeholder="Contoh:
3	19-11-2025	83	83	81	81	71.662.000	5.804.622.000	0.00%	0.00%	-2.41%	-2.41%	0.00%	1.20%
4	18-11-2025	85	86	82	83	186.766.100	15.501.586.300	0.00%	1.18%	-3.53%	-2.35%	1.18%	2.33%
5	17-11-2025	85	86	84	85	285.654.200	24.280.607.000	1.19%	2.38%	0.00%	1.19%	1.18%	3.49%"></textarea>
            <button onclick="analyzeStock()">üöÄ ANALISIS SUPER EARLY</button>
        </div>

        <div id="result" class="result" style="display:none;"></div>
        <div class="chart-container">
            <canvas id="stockChart"></canvas>
        </div>
    </div>

    <script>
        function analyzeStock() {
            const dataInput = document.getElementById('stockData').value;
            const stockData = parseStockData(dataInput);
            
            if (stockData.length < 3) {
                alert('‚ùå Minimal 3 data hari diperlukan');
                return;
            }

            const analysis = analyzeStockData(stockData);
            displayResult(analysis, stockData);
        }

        function parseStockData(textData) {
            const lines = textData.trim().split('\n');
            const stockData = [];
            
            for (const line of lines) {
                if (line.trim() === '') continue;
                
                const parts = line.trim().split('\t');
                if (parts.length >= 7) {
                    try {
                        const dataPoint = {
                            Day: parseInt(parts[0]),
                            Date: parts[1],
                            Open: parseFloat(parts[2].replace('.', '').replace(',', '.')),
                            High: parseFloat(parts[3].replace('.', '').replace(',', '.')),
                            Low: parseFloat(parts[4].replace('.', '').replace(',', '.')),
                            Close: parseFloat(parts[5].replace('.', '').replace(',', '.')),
                            Volume: parseFloat(parts[6].replace(/\./g, '').replace(',', '.')),
                            Value: parts[7] ? parseFloat(parts[7].replace(/\./g, '').replace(',', '.')) : 0
                        };
                        
                        if (!isNaN(dataPoint.Close) && !isNaN(dataPoint.Volume)) {
                            stockData.push(dataPoint);
                        }
                    } catch (e) {
                        console.log('Error parsing line:', line, e);
                    }
                }
            }
            
            return stockData.reverse();
        }

        function analyzeStockData(stockData) {
            const closes = stockData.map(d => d.Close);
            const volumes = stockData.map(d => d.Volume);
            const highs = stockData.map(d => d.High);
            const lows = stockData.map(d => d.Low);
            
            // ULTRA SENSITIVE RSI - periode pendek
            const rsi = calculateUltraRSI(closes, 6);
            const currentRSI = rsi[rsi.length - 1];
            
            // VOLUME ANALYSIS - super sensitive
            const volume3 = volumes.slice(-3);
            const volume5 = volumes.slice(-5);
            const currentVolume = volumes[volumes.length - 1];
            const avgVolume3 = calculateAverage(volume3);
            const avgVolume5 = calculateAverage(volume5);
            const volumeRatio3 = currentVolume / avgVolume3;
            const volumeRatio5 = currentVolume / avgVolume5;
            
            // PRICE MOMENTUM - ultra sensitive
            const currentPrice = closes[closes.length - 1];
            const price3dAgo = closes.length >= 4 ? closes[closes.length - 4] : closes[0];
            const priceChange3d = (currentPrice - price3dAgo) / price3dAgo;
            
            // SUPPORT/RESISTANCE - dynamic
            const recentLows = lows.slice(-5);
            const recentHighs = highs.slice(-5);
            const supportLevel = Math.min(...recentLows);
            const resistanceLevel = Math.max(...recentHighs);
            const distanceToSupport = (currentPrice - supportLevel) / currentPrice;
            const distanceToResistance = (resistanceLevel - currentPrice) / currentPrice;
            
            // VOLATILITY COMPRESSION - key indicator
            const ranges = highs.map((high, i) => (high - lows[i]) / lows[i]);
            const recentRanges = ranges.slice(-3);
            const avgRecentRange = calculateAverage(recentRanges);
            const historicalRanges = ranges.slice(0, -3);
            const avgHistoricalRange = historicalRanges.length > 0 ? calculateAverage(historicalRanges) : avgRecentRange;
            const compressionRatio = avgRecentRange / avgHistoricalRange;
            
            // LIQUIDITY DRYNESS - main factor
            const volumeDryness = Math.min(volumeRatio3, volumeRatio5);
            
            console.log('Analysis Data:', {
                currentRSI, volumeRatio3, volumeRatio5, volumeDryness,
                priceChange3d, distanceToSupport, compressionRatio
            });

            // ULTRA AGGRESSIVE SCORING - Fokus pada deteksi dini
            let score = 0;
            let reasons = [];
            let strongSignals = 0;

            // 1. RSI - SUPER SENSITIVE (40 points)
            if (currentRSI < 40) {
                score += 20;
                reasons.push(`üéØ RSI ${currentRSI.toFixed(1)} (UNDER 40) - OVERSOLD SIGNAL`);
                strongSignals++;
            }
            if (currentRSI < 35) {
                score += 15;
                reasons.push(`üìâ RSI ${currentRSI.toFixed(1)} (UNDER 35) - STRONG OVERSOLD`);
                strongSignals++;
            }

            // 2. VOLUME DRYNESS - MAIN CRITERIA (50 points)
            if (volumeDryness < 0.8) {
                score += 20;
                reasons.push(`üíß Volume ${(volumeDryness * 100).toFixed(0)}% dari rata2 - MULAI KERING`);
                strongSignals++;
            }
            if (volumeDryness < 0.6) {
                score += 20;
                reasons.push(`üí® Volume ${(volumeDryness * 100).toFixed(0)}% dari rata2 - KERING SIGNIFIKAN`);
                strongSignals++;
            }
            if (volumeDryness < 0.4) {
                score += 10;
                reasons.push(`üèúÔ∏è Volume ${(volumeDryness * 100).toFixed(0)}% dari rata2 - SANGAT KERING`);
                strongSignals++;
            }

            // 3. PRICE POSITION (30 points)
            if (distanceToSupport < 0.03) {
                score += 20;
                reasons.push(`üõ°Ô∏è Harga ${(distanceToSupport * 100).toFixed(1)}% di atas support - DEKAT SUPPORT`);
                strongSignals++;
            }
            if (priceChange3d < -0.02) {
                score += 10;
                reasons.push(`üìâ Turun ${(priceChange3d * 100).toFixed(1)}% dalam 3 hari - KOREKSI SEHAT`);
            }

            // 4. VOLATILITY COMPRESSION (30 points)
            if (compressionRatio < 0.7) {
                score += 15;
                reasons.push(`‚ö° Volatilitas ${(compressionRatio * 100).toFixed(0)}% dari normal - KOMPRESI TINGGI`);
                strongSignals++;
            }
            if (compressionRatio < 0.5) {
                score += 15;
                reasons.push(`üé≠ Volatilitas ${(compressionRatio * 100).toFixed(0)}% dari normal - KOMPRESI EKSTREM`);
                strongSignals++;
            }

            // 5. BREAKOUT POTENTIAL (20 points)
            if (distanceToResistance > 0.08) {
                score += 10;
                reasons.push(`üöÄ Room to grow ${(distanceToResistance * 100).toFixed(1)}% ke resistance - POTENSI BESAR`);
            }
            if (distanceToResistance > 0.15) {
                score += 10;
                reasons.push(`üìà Room to grow ${(distanceToResistance * 100).toFixed(1)}% ke resistance - POTENSI SANGAT BESAR`);
            }

            const totalScore = Math.min(100, score);
            const normalizedScore = (totalScore / 100) * 10;

            // ULTRA AGGRESSIVE DECISION MAKING
            let status = 'NORMAL';
            let buyRecommendation = '';
            let prediction = '';

            // HANYA 2 KONDISI: POTENSI atau NORMAL
            if (normalizedScore >= 4.5 || strongSignals >= 2) {
                status = 'POTENSI';
                buyRecommendation = 'üî• BELI SEKARANG! POTENSI BESAR BESOK NAIK!';
                prediction = `üöÄ SAHAM SUDAH KERING! ${strongSignals} sinyal kuat terdeteksi. ` +
                           `RSI: ${currentRSI.toFixed(1)}, Volume: ${(volumeDryness * 100).toFixed(0)}% dari normal. ` +
                           `SANGAT BERPOTENSI NAIK BESOK!`;
            } else {
                status = 'NORMAL';
                buyRecommendation = '‚è≥ TUNGGU - Belum cukup sinyal kering';
                prediction = `Saham masih normal. Butuh ${Math.max(1, 5 - strongSignals)} sinyal lagi untuk konfirmasi.`;
            }

            // JIKA VOLUME SANGAT KERING (<50%) DAN RSI < 40 -> AUTO POTENSI
            if (volumeDryness < 0.5 && currentRSI < 40) {
                status = 'POTENSI';
                buyRecommendation = 'üî•üî• BELI OTOMATIS! VOLUME KERING + RSI OVERSOLD!';
                prediction = `üöÄüöÄ KONDISI IDEAL! Volume kering (${(volumeDryness * 100).toFixed(0)}%) + RSI oversold (${currentRSI.toFixed(1)}) = POTENSI LUAR BIASA!`;
            }
            
            return {
                status,
                score: Math.round(normalizedScore * 10) / 10,
                strongSignals,
                reasons,
                prediction,
                buyRecommendation,
                metrics: {
                    rsi: currentRSI,
                    volumeDryness: volumeDryness * 100,
                    distanceToSupport: distanceToSupport * 100,
                    compressionRatio: compressionRatio * 100,
                    currentPrice,
                    supportLevel,
                    resistanceLevel
                }
            };
        }

        function calculateUltraRSI(closes, period = 6) {
            if (closes.length < period + 1) return Array(closes.length).fill(50);
            
            const gains = [];
            const losses = [];
            
            for (let i = 1; i < closes.length; i++) {
                const difference = closes[i] - closes[i - 1];
                gains.push(Math.max(difference, 0));
                losses.push(Math.max(-difference, 0));
            }
            
            const rsi = [];
            
            let avgGain = gains.slice(0, period).reduce((a, b) => a + b) / period;
            let avgLoss = losses.slice(0, period).reduce((a, b) => a + b) / period;
            
            if (avgLoss === 0) {
                rsi.push(100);
            } else {
                const rs = avgGain / avgLoss;
                rsi.push(100 - (100 / (1 + rs)));
            }
            
            for (let i = period; i < gains.length; i++) {
                avgGain = ((avgGain * (period - 1)) + gains[i]) / period;
                avgLoss = ((avgLoss * (period - 1)) + losses[i]) / period;
                
                if (avgLoss === 0) {
                    rsi.push(100);
                } else {
                    const rs = avgGain / avgLoss;
                    rsi.push(100 - (100 / (1 + rs)));
                }
            }
            
            return Array(closes.length - rsi.length).fill(null).concat(rsi);
        }

        function calculateAverage(arr) {
            const validArr = arr.filter(val => !isNaN(val));
            if (validArr.length === 0) return 0;
            return validArr.reduce((a, b) => a + b) / validArr.length;
        }

        function displayResult(analysis, stockData) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            
            const buyClass = analysis.status === 'POTENSI' ? 'buy-yes' : 'buy-wait';
            
            let html = `
                <h2>üìä Hasil Analisis: <strong>${analysis.status}</strong></h2>
                
                <div class="buy-recommendation ${buyClass}">
                    ${analysis.buyRecommendation}
                </div>
                
                <div class="metric-grid">
                    <div class="metric-card">
                        <div class="metric-value">${analysis.score}/10</div>
                        <div class="metric-label">AGGRESSIVE SCORE</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${analysis.metrics.rsi.toFixed(1)}</div>
                        <div class="metric-label">RSI (6)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${analysis.metrics.volumeDryness.toFixed(0)}%</div>
                        <div class="metric-label">VOLUME KERING</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">${analysis.strongSignals}</div>
                        <div class="metric-label">SINYAL KUAT</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 8px;">
                    <h3>üéØ Prediction:</h3>
                    <p style="font-size: 18px; font-weight: bold; margin: 10px 0;">${analysis.prediction}</p>
                </div>
            `;
            
            if (analysis.reasons.length > 0) {
                html += `
                    <h3>üìã Sinyal yang Terdeteksi:</h3>
                    <div class="reasons-list">
                        <ul>
                `;
                analysis.reasons.forEach(reason => {
                    // Tambahkan badge untuk sinyal kuat
                    const isStrongSignal = reason.includes('üéØ') || reason.includes('üí®') || 
                                         reason.includes('üèúÔ∏è') || reason.includes('üõ°Ô∏è') ||
                                         reason.includes('‚ö°') || reason.includes('üé≠');
                    const badge = isStrongSignal ? '<span class="signal-badge signal-strong">KUAT</span>' : '<span class="signal-badge signal-medium">MEDIUM</span>';
                    
                    html += `<li>${reason} ${badge}</li>`;
                });
                html += `</ul></div>`;
            }
            
            // Trading advice
            html += `
                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
                    <h3>üí° Strategy Trading:</h3>
                    <p><strong>${
                        analysis.status === 'POTENSI' ? 
                        'ENTRY SEKARANG! - Buy di harga saat ini. Target 3-5% gain besok. Stop loss di support level.' :
                        'TUNGGU - Pantau volume dan RSI. Entry ketika volume < 60% dan RSI < 40.'
                    }</strong></p>
                </div>
            `;

            resultDiv.className = 'result ' + (analysis.status === 'POTENSI' ? 'potensi' : 'normal');
            resultDiv.innerHTML = html;
            
            createChart(stockData, analysis);
        }

        function createChart(stockData, analysis) {
            const ctx = document.getElementById('stockChart').getContext('2d');
            const dates = stockData.map(d => d.Date);
            const closes = stockData.map(d => d.Close);
            const volumes = stockData.map(d => d.Volume);
            
            if (window.stockChartInstance) {
                window.stockChartInstance.destroy();
            }
            
            window.stockChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Close Price',
                            data: closes,
                            type: 'line',
                            borderColor: analysis.status === 'POTENSI' ? '#dc3545' : '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Volume',
                            data: volumes,
                            backgroundColor: analysis.status === 'POTENSI' ? 
                                'rgba(220, 53, 69, 0.3)' : 'rgba(200, 200, 200, 0.3)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: 'Volume'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Stock Analysis - ${analysis.status} - ${analysis.buyRecommendation}`,
                            font: {
                                size: 16
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
